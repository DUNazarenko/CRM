{% extends "base.html" %}
{% block title %}Админ панель - CRM{% endblock %}
{% block content %}

<div class="container-fluid mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2><i class="fas fa-users me-2"></i>Список клиентов</h2>
    <div>
      <input id="search" type="text" class="form-control d-inline w-auto" placeholder="Поиск..." />
      <select id="filter-status" class="form-select d-inline w-auto">
        <option value="">Все</option>
        <option value="has_db">С базой</option>
        <option value="no_db">Без базы</option>
      </select>
      <button class="btn btn-primary ms-2" onclick="loadClients()">
        <i class="fas fa-search"></i>
      </button>
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <table class="table table-striped align-middle" id="clients-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Компания</th>
            <th>Email</th>
            <th>Телефон</th>
            <th>Профиль</th>
            <th>База данных</th>
            <th>Действия</th>
          </tr>
        </thead>
        <tbody id="clients-body"></tbody>
      </table>
      <div id="empty" class="text-center text-muted mt-3" style="display:none;">
        Нет клиентов по выбранным фильтрам
      </div>
    </div>
  </div>
</div>

<script>
async function loadClients() {
  const query = document.getElementById('search').value.trim();
  const status = document.getElementById('filter-status').value;
  const res = await fetch(`/api/admin/clients?query=${encodeURIComponent(query)}&status=${encodeURIComponent(status)}`);
  const data = await res.json();

  const tbody = document.getElementById('clients-body');
  tbody.innerHTML = '';
  if (!data.length) {
    document.getElementById('empty').style.display = 'block';
    return;
  }
  document.getElementById('empty').style.display = 'none';

  data.forEach(c => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${c.id}</td>
      <td>${c.company_name}</td>
      <td>${c.email || '—'}</td>
      <td>${c.phone || '—'}</td>
      <td><span class="badge bg-info">${c.profile_name || '—'}</span></td>
      <td><code>${c.database_name}</code></td>
      <td>
        <button class="btn btn-success btn-sm me-1" onclick="createDB(${c.id})"><i class="fas fa-database"></i></button>
        <button class="btn btn-outline-primary btn-sm me-1" onclick="manageClient(${c.id})"><i class="fas fa-cog"></i></button>
        <button class="btn btn-outline-danger btn-sm" onclick="deleteClient(${c.id})"><i class="fas fa-trash"></i></button>
      </td>`;
    tbody.appendChild(tr);
  });
}

async function createDB(id) {
  if (!confirm('Создать базу данных для клиента?')) return;
  const res = await fetch(`/api/admin/clients/${id}/create-database`, { method: 'POST' });
  const data = await res.json();
  alert(data.message || 'Готово');
  loadClients();
}

async function deleteClient(id) {
  if (!confirm('Удалить клиента?')) return;
  await fetch(`/api/admin/clients/${id}`, { method: 'DELETE' });
  loadClients();
}

function manageClient(id) {
  alert('Управление клиентом ' + id);
}

document.addEventListener('DOMContentLoaded', loadClients);
</script>

<style>
.btn-primary { background: linear-gradient(135deg, #e6311d 0%, #ff4b2b 100%); border: none; }
.badge.bg-info { background-color: #0078d4 !important; }
</style>

{% endblock %}
