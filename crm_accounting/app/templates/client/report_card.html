{% extends "client_base.html" %}
{% block title %}{{ report.short_name }} - CRM Бухгалтерия{% endblock %}

{% block content %}
<div class="container-fluid p-0">
    <div class="d-flex justify-content-between align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">
            <i class="fas fa-file-alt me-2"></i>{{ report.full_name }}
        </h1>
        <a href="/client/{{ client.id }}/reports" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Назад к списку
        </a>
    </div>

    <div class="card mb-4">
        <div class="card-body">
            <h5><i class="fas fa-info-circle me-2"></i>Информация об отчёте</h5>
            <p><strong>Полное наименование:</strong> {{ report.full_name }}</p>
            <p><strong>Сокращённое наименование:</strong> {{ report.short_name }}</p>
            {% if report.description %}
            <p><strong>Описание:</strong> {{ report.description }}</p>
            {% endif %}
        </div>
    </div>

    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-calendar me-2"></i>Периоды сдачи</h5>
            <button class="btn btn-primary-custom btn-sm" data-bs-toggle="modal" data-bs-target="#addPeriodModal">
                <i class="fas fa-plus me-1"></i>Добавить период
            </button>
        </div>

        <div class="card-body">
            {% if periods %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Период</th>
                            <th>Год</th>
                            <th>Срок сдачи</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for p in periods %}
                        <tr>
                            <td>{{ p.period }}</td>
                            <td>{{ p.year }}</td>
                            <td>{{ p.due_date.strftime('%d.%m.%Y') }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-4">
                <i class="fas fa-calendar fa-3x text-muted mb-3"></i>
                <p class="text-muted">Периоды не добавлены</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Модалка добавления периода -->
<div class="modal fade" id="addPeriodModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Добавить период</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addPeriodForm" method="post" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label class="form-label">Период *</label>
                        <select class="form-control" name="period" required>
                            <option value="">Выберите период</option>
                            {% for p in [
                                "1 квартал","2 квартал","3 квартал","4 квартал",
                                "январь","февраль","март","апрель","май","июнь",
                                "июль","август","сентябрь","октябрь","ноябрь","декабрь",
                                "полугодие","9 месяцев","год"
                            ] %}
                            <option value="{{ p }}">{{ p }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Год *</label>
                        <input type="number" class="form-control" name="year" value="{{ today.year }}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Срок сдачи *</label>
                        <input type="date" class="form-control" name="due_date" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary-custom" onclick="createReportPeriod()">Добавить</button>
            </div>
        </div>
    </div>
</div>

<script>
async function createReportPeriod() {
    const form = document.getElementById('addPeriodForm');
    const formData = new FormData(form);

    if (!formData.get('period') || !formData.get('year') || !formData.get('due_date')) {
        alert('Заполните все поля!');
        return;
    }

    const btn = document.querySelector('#addPeriodModal .btn-primary-custom');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Сохранение...';

    try {
        const response = await fetch(`/client/{{ client.id }}/reports/{{ report.id }}/periods`, {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            const result = await response.json();
            alert('Период успешно добавлен!');
            const modal = bootstrap.Modal.getInstance(document.getElementById('addPeriodModal'));
            modal.hide();
            location.reload();
        } else {
            const errorText = await response.text();
            console.error('Error response:', errorText);
            alert('Ошибка при добавлении периода: ' + (errorText || 'Неизвестная ошибка'));
        }
    } catch (err) {
        console.error(err);
        alert('Ошибка добавления периода: ' + err.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = 'Добавить';
    }
}
</script>
{% endblock %}